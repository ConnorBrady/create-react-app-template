function AddScript(tab,scriptFile){chrome.tabs.executeScript(tab.id,{file:scriptFile},function(){});};function addIt(){myEmbed=document.createElement('embed');myEmbed.setAttribute("type","application/allavsoft-plugin");myEmbed.setAttribute("id","pluginId");document.body.appendChild(myEmbed);}function getVideoUrl(callback,url,host){var xhr=new XMLHttpRequest();xhr.onreadystatechange=function(data){if(xhr.readyState==4){if(xhr.status==200){var data=xhr.responseText;var elts;var videoUrl;if(host=='comcast'){elts=/<url>(.*)<\/url>/g.exec(data);videoUrl=elts[1].toString();}if(host=='teachertube'){elts=/<.*(http:\/\/.*\.flv)"\/>/g.exec(data);videoUrl=elts[1].toString();}if(host=='vimeo'){var sig=/<request_signature>(.*)<\/request_signature>/g.exec(data);var sig_expire=/<request_signature_expires>(.*)<\/request_signature_expires>/g.exec(data);videoUrl=url.replace('load','play')+'\/'+sig[1].toString()+'\/'+sig_expire[1].toString()+'\/?q=sd&type=embed';}callback(videoUrl);}else{callback(null);}}};xhr.open('GET',url,true);xhr.send();};function onRequest(request,sender,callback){if(request.action=='addScript'){var scriptFile=request.scriptFile;chrome.tabs.executeScript(sender.tab.id,{file:scriptFile},function(){});}if(request.action=='AddUrl'){var videoURL=request.videoURL;var bObject=request.bObject;var bRedirect=request.bRedirect;var plugin=document.getElementById("pluginId");if(bObject&&bObject==true){for(var i=0;i<videoURL.length;i++){plugin.addUrl(videoURL[i][0],videoURL[i][1],bObject);}}}if(request.action=='ShowButton'){var Rect={x:0,y:0,w:0,h:0};var userAgent=navigator.userAgent.toLowerCase();var chromeVersion=userAgent.match(/chrome\/([^.])*/g);Rect=request.Rect;var pageUrl=request.pageUrl;var title=request.title;var cookie=request.cookie;var videoUrl=request.videoUrl;var bIsHtml5=request.bIsHtml5;var plugin=document.getElementById("pluginId");plugin.showButton(Rect.x,Rect.y,Rect.w,Rect.h,pageUrl,chromeVersion.toString(),title,cookie,videoUrl,bIsHtml5);}if(request.action=='HideButton'){var userAgent=navigator.userAgent.toLowerCase();var chromeVersion=userAgent.match(/chrome\/([^.]*)/g);var pageUrl=request.pageUrl;var plugin=document.getElementById("pluginId");plugin.hideButton(pageUrl,sender.tab.id,chromeVersion.toString());}if(request.action=='getVideoUrl'){var url=request.addr;var host=request.host;getVideoUrl(callback,url,host);}};addIt();chrome.extension.onRequest.addListener(onRequest);chrome.tabs.onUpdated.addListener(function(tabId,changeInfo,tab){var plugin=document.getElementById("pluginId");if(changeInfo.status=="loading"&&(tab.url.indexOf("http://")!=-1||tab.url.indexOf("https://")!=-1)){plugin.clearUrl(tab.url)}});

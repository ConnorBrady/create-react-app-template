var BSExtract={};(function(){var request;createRequest();var clipID;var requestSignature;var requestSignatureExpires;var isHD;var vimeoVideoURL="";var retryTimes=5;function createRequest(){try{request=new XMLHttpRequest();}catch(trymicrosoft){try{request=new ActiveXObject("Msxml2.XMLHTTP");}catch(othermicrosoft){try{request=new ActiveXObject("Microsoft.XMLHTTP");}catch(failed){request=false;}}}if(!request)console.log("Error initializing XMLHttpRequest!");}var requestPool=[];var attachedBtnList=[];var isRequesting=false;function delRepetitive(attachElement){for(var i=0;i<attachedBtnList.length;i++){if(attachElement==attachedBtnList[i].attachElement){BSFunction.unbind_mouseover(attachElement,attachedBtnList[i].buttonDiv);BSFunction.deleteAttachedButton(attachedBtnList[i].buttonDiv);attachedBtnList.splice(i,1);break;}}}function requestVideoURL(clipID){requestPool.push({clipID:clipID});if(!isRequesting){doRequest();}}function doRequest(){if(requestPool.length>0){var rq=requestPool[0];if(rq){var url="/moogaloop/load/clip:"+escape(rq.clipID);var xmlVideoUrl='http://www.vimeo.com/moogaloop/load/clip:'+rq.clipID;chrome.extension.sendRequest({'action':'getVideoUrl','addr':xmlVideoUrl,'host':'vimeo'},function(videoUrl){var videoURL=bvd_InfoExtractor.getVideoInfo(videoUrl);var userAgent=window.navigator.userAgent;videoURL=videoURL.concat('-BVD-SEP-',userAgent);BSMyTubeGetModule.AddUrl(videoURL,false,true);});isRequesting=true;}}}function onRequestFinished(){if(request.readyState==4){if(request.status==200){alert('onRequestFinished');var needRetry=true;parser=new DOMParser();var xmlDoc=parser.parseFromString(request.responseText,"text/xml");if(xmlDoc){requestSignatureNode=xmlDoc.getElementsByTagName("request_signature");var rq=requestPool[0];if(requestSignatureNode.length>0&&requestSignatureNode[0].childNodes.length>0){requestSignature=requestSignatureNode[0].childNodes[0].nodeValue;requestSignatureExpires=xmlDoc.getElementsByTagName("request_signature_expires")[0].childNodes[0].nodeValue;isHD=xmlDoc.getElementsByTagName("isHD")[0].childNodes[0].nodeValue;vimeoVideoURL="http://vimeo.com/moogaloop/play/clip:"+rq.clipID+"/"+requestSignature+"/"+requestSignatureExpires+"/?q="+isHD;alert('vimeoVideoURL: '+vimeoVideoURL);var playerDiv=rq.attachElement;if(playerDiv){var videoURL=bvd_InfoExtractor.getVideoInfo(vimeoVideoURL);alert('videoURL: '+videoURL);delRepetitive(playerDiv);btnDownloadDiv=BSFunction.attachButtonDiv(playerDiv,AttachStyleEnum.AttachOuterTopRight,"",videoURL);BSFunction.bind_mouseover(playerDiv,btnDownloadDiv);attachedBtnList.push({attachElement:playerDiv,buttonDiv:btnDownloadDiv});requestPool.splice(0,1);needRetry=false;retryTimes=5;isRequesting=false;doRequest();return;}}}if(needRetry&&retryTimes>0){retryTimes--;}else{requestPool.splice(0,1);needRetry=false;retryTimes=5;}isRequesting=false;doRequest();}}}function attachButtonForHTML5(element){var videoElement=element;var videoURL=videoElement.getAttribute("src");if(videoURL[0]=="/"&&videoURL[1]=="/"){videoURL="http:"+videoURL;}var videoURL=bvd_InfoExtractor.getVideoInfo(videoURL);var playerDiv=element.parentNode.parentNode.parentNode;if(playerDiv){delRepetitive(playerDiv);var btnDiv=BSFunction.attachButtonDiv(playerDiv,AttachStyleEnum.AttachOuterTopRight,"",videoURL);BSFunction.bind_mouseover(playerDiv,btnDiv);attachedBtnList.push({attachElement:playerDiv,buttonDiv:btnDiv});}}function handleBeforeLoadEvent(event){var element=event.target;if(element.allowedToLoad)return;if(!(element instanceof HTMLObjectElement||element instanceof HTMLEmbedElement||element instanceof HTMLVideoElement))return;if(element.getAttribute("classid"))return;isHTML5=element instanceof HTMLVideoElement;var playerNode=element;do{playerNode=playerNode.parentNode;}while(playerNode&&playerNode.className!="f player")if(!playerNode)return;var playerID=playerNode.id.split("_");var clip_id=playerID[1];if(isHTML5){attachButtonForHTML5(element);}else{requestVideoURL(clip_id);}}function getElementsByClassName(className,term){var parentEle=null;if(term.parentObj){parentEle=typeof term.parentObj=='string'?document.getElementById(term.parentObj):term.parentObj;}var rt=[],coll=(parentEle==null?document:parentEle).getElementsByTagName(term.tagName||'*');for(var i=0;i<coll.length;i++){if(coll[i].className.match(new RegExp('(\\s|^)'+className+'(\\s|$)'))){rt[rt.length]=coll[i];}}return rt;}function handleReadystatechangeEvent(e){if(document.readyState=="complete"){var players=document.getElementsByClassName('f player');var player=players[0];if(player){var playerID=player.id.split('_');var clip_id=playerID[1];alert('clip_id: '+clip_id);requestVideoURL(clip_id);}}}var isHTML5=false;document.addEventListener("beforeload",handleBeforeLoadEvent,true);})();
